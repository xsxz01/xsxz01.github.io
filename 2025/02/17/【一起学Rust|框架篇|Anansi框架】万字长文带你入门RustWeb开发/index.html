

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="广龙宇">
  <meta name="keywords" content="前端,前端开发,后端,后端开发,Rust,Python,Java,PHP,Tauri,Tauri开发,Tauri2.0,Angular,JavaScript,NodeJs,Ubuntu,Fedora,单片机,esp32,Arduino,物联网,Iot,编程学习资源,初学者编程指南,编程教程">
  
    <meta name="description" content="前言新手学习一门编程语言总是很迷茫的，除了枯燥的语法，还要学习其庞大的生态，如果你不了解生态，那么掌握语法也是空。在Rust中，也有着跟其他语言一样的Web开发生态，但是基本上都是一言难尽。如果你对rust比较关注，那么你至少应该了解过Axum，Rocket，Actix-web三座大山，但是rust学习曲线陡峭，我认为新手尤其是国内开发者并不适合使用这些，本来语法就难，还要被各种概念卷的晕头转向，">
<meta property="og:type" content="article">
<meta property="og:title" content="【一起学Rust|框架篇|Anansi框架】万字长文带你入门RustWeb开发">
<meta property="og:url" content="https://www.iotlearn.cn/2025/02/17/%E3%80%90%E4%B8%80%E8%B5%B7%E5%AD%A6Rust|%E6%A1%86%E6%9E%B6%E7%AF%87|Anansi%E6%A1%86%E6%9E%B6%E3%80%91%E4%B8%87%E5%AD%97%E9%95%BF%E6%96%87%E5%B8%A6%E4%BD%A0%E5%85%A5%E9%97%A8RustWeb%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="广龙宇">
<meta property="og:description" content="前言新手学习一门编程语言总是很迷茫的，除了枯燥的语法，还要学习其庞大的生态，如果你不了解生态，那么掌握语法也是空。在Rust中，也有着跟其他语言一样的Web开发生态，但是基本上都是一言难尽。如果你对rust比较关注，那么你至少应该了解过Axum，Rocket，Actix-web三座大山，但是rust学习曲线陡峭，我认为新手尤其是国内开发者并不适合使用这些，本来语法就难，还要被各种概念卷的晕头转向，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/05d742824eba481588940c8183b78871.png#pic_center">
<meta property="article:published_time" content="2025-02-17T03:26:07.000Z">
<meta property="article:modified_time" content="2025-02-17T03:28:14.600Z">
<meta property="article:author" content="广龙宇">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="核心技术">
<meta property="article:tag" content="rust">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/05d742824eba481588940c8183b78871.png#pic_center">
  
  
  <title>【一起学Rust|框架篇|Anansi框架】万字长文带你入门RustWeb开发 - 广龙宇</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"www.iotlearn.cn","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":["home","post","tag","category","about","links","page","404"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0,"placement":"right"},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"fb662cce851f414746e9757acbf65392","google":{"measurement_id":null},"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"follow_dnt":true},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<!-- hexo injector head_end start --><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1485372591247153" crossorigin="anonymous"></script><style>ins.adsbygoogle[data-ad-status="unfilled"] { display: none !important; }</style><meta name="baidu-site-verification" content="codeva-ewKi1qqR4z" /><meta name="google-site-verification" content="37uUYK-9nH6gx-IxEnSbVtr4dSqgaT0h2S7gwKc-Gr4" /><meta name=referrer content=no-referrer /><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>GuangLongYu</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7/">
                <i class="iconfont icon-briefcase"></i>
                常用工具
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/images/20241016/bg_article.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="【一起学Rust|框架篇|Anansi框架】万字长文带你入门RustWeb开发">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      广龙宇
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2025-02-17 11:26" pubdate>
        2025年2月17日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      20k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      169 分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">【一起学Rust|框架篇|Anansi框架】万字长文带你入门RustWeb开发</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：3 分钟前
                
              </p>
            
            <div class="markdown-body">
              <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>新手学习一门编程语言总是很迷茫的，除了枯燥的语法，还要学习其庞大的生态，如果你不了解生态，那么掌握语法也是空。在Rust中，也有着跟其他语言一样的Web开发生态，但是基本上都是一言难尽。如果你对rust比较关注，那么你至少应该了解过Axum，Rocket，Actix-web三座大山，但是rust学习曲线陡峭，我认为新手尤其是国内开发者并不适合使用这些，本来语法就难，还要被各种概念卷的晕头转向，我更推荐Salvo（赛风），功能全，文档也丰富，更加适合中国开发者。本文介绍的是一个设计理念跟Django差不多的轻量化Web开发框架，虽然小众，但是五脏俱全，可快速开发出简单的web应用。</p>
<hr>
<p>Anansi是一个使用Rust写的简单MVC的web框架，在我的使用体验中，我更加觉得这个框架就是Rust版的Django,如果你有Django开发经验，那么将会非常轻而易举的上手开发安全又高性能的web应用，如果你没有Django开发经验，那么也不要慌，跟着本文做完这个小demo,基本上可以用rust做出你想象中的那个应用。</p>
<p>让我们现在就开始入门学习他吧。</p>
<hr>
<h1 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h1><p>首先执行以下命令安装Anansi</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs cmake">cargo <span class="hljs-keyword">install</span> ananc<br></code></pre></td></tr></table></figure>
<p>执行以后会自动将依赖等都安装好，就是下图的样子。<br><img src="https://i-blog.csdnimg.cn/blog_migrate/d0118e9b4db6e89a6464d5c50a2f0ef7.png" srcset="/img/loading.gif" lazyload>查看Anansi的版本，如果返回版本号，说明你已经安装成功，运行正确的结果如下图所示</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">ananc <span class="hljs-comment">--version</span><br></code></pre></td></tr></table></figure>

<p><img src="https://i-blog.csdnimg.cn/blog_migrate/364d0d9a29c8276163b9a8411dd1b1f8.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="二、入门案例"><a href="#二、入门案例" class="headerlink" title="二、入门案例"></a>二、入门案例</h1><blockquote>
<p>注意：本段内容为官网原文翻译</p>
</blockquote>
<h2 id="1-创建一个基础的网站"><a href="#1-创建一个基础的网站" class="headerlink" title="1.创建一个基础的网站"></a>1.创建一个基础的网站</h2><p>确保你的版本与我一致，然后创建一个项目</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">ananc <span class="hljs-keyword">new</span> mini-forum<br></code></pre></td></tr></table></figure>
<p>这个代码将会创建一个名字为<code>mini-forum</code>的项目，其中包含以下必要文件</p>
<ul>
<li><code>http_errors/</code> - http错误处理页面</li>
<li><code>main.rs</code> - 应用和集合</li>
<li><code>project.rs</code> - 项目设置</li>
<li><code>urls.rs</code> - 管理路由</li>
</ul>
<blockquote>
<p>从以上文件可以看出这个web框架其实就是mvc的老三样。</p>
</blockquote>
<p><strong>注意</strong>：Anansi默认自带一个Sqlite数据库，如果你想要使用PostgreSQL，那么需要完成以下三步</p>
<ol>
<li>在<code>Cargo.toml</code>中将<code>sqlite</code>改成<code>postgres</code></li>
<li>在<code>src/project.rs</code>中修改<code>database!(sqlite)</code>为<code>database!(postgres)</code></li>
<li>在<code>settings.toml</code>将<code>[databases.default]</code>部分修改成以下代码</li>
</ol>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs toml"><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;mydatabase&quot;</span><br><span class="hljs-attr">user</span> = <span class="hljs-string">&quot;myuser&quot;</span><br><span class="hljs-attr">password</span> = <span class="hljs-string">&quot;mypassword&quot;</span><br><span class="hljs-attr">address</span> = <span class="hljs-string">&quot;127.0.0.1:5432&quot;</span><br></code></pre></td></tr></table></figure>

<h2 id="2-启动web服务器"><a href="#2-启动web服务器" class="headerlink" title="2.启动web服务器"></a>2.启动web服务器</h2><p>启动web服务器非常简单，只需要cmd切换到<code>mini-forum/ </code>目录，然后运行以下命令即可</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">ananc <span class="hljs-built_in">run</span><br></code></pre></td></tr></table></figure>

<p>如果运行没有任何错误，直接访问<code>http://127.0.0.1:9090/</code>即可看到创建的网站了。</p>
<blockquote>
<p>官方项目git: <a target="_blank" rel="noopener" href="https://github.com/saru-tora/mini-forum">https://github.com/saru-tora/mini-forum</a></p>
</blockquote>
<h2 id="3-创建一个应用"><a href="#3-创建一个应用" class="headerlink" title="3.创建一个应用"></a>3.创建一个应用</h2><p>这块内容用过Django的都熟悉，应该能轻松理解，你只需要知道一个web由多个应用组成就行了。<br>运行以下命令来创建一个应用，以名字<code>forum</code>为例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ananc app forum<br></code></pre></td></tr></table></figure>

<p>然后你就会看到创建了一个<code>forum</code>目录，其中有以下文件</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">.<br>├── migrations<br>├── mod<span class="hljs-selector-class">.rs</span><br>├── records<span class="hljs-selector-class">.rs</span><br>└── urls.rs<br></code></pre></td></tr></table></figure>

<blockquote>
<p>这些文件的功能你跟着教程走下去就知道是做什么的了。</p>
</blockquote>
<p>接下来在<code>main.rs</code>中包含启用这个应用</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">mod</span> forum;<br><br>apps! &#123;<br>    auth,<br>    sessions,<br>    forum,<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-定义记录结构"><a href="#4-定义记录结构" class="headerlink" title="4.定义记录结构"></a>4.定义记录结构</h2><p>在<code>forum</code>目录应该能看到文件<code>records.rs</code>，这个就是记录，也就是数据库中的记录，首先定义记录结构，</p>
<blockquote>
<p>等同于Entity</p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::records::&#123;VarChar, DateTime, ForeignKey&#125;;<br><span class="hljs-keyword">use</span> anansi::util::auth::records::User;<br><br><span class="hljs-meta">#[record]</span><br><span class="hljs-meta">#[derive(Relate, FromParams)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Topic</span> &#123;<br>    <span class="hljs-keyword">pub</span> title: VarChar&lt;<span class="hljs-number">200</span>&gt;,<br>    <span class="hljs-keyword">pub</span> user: ForeignKey&lt;User&gt;,<br>    <span class="hljs-keyword">pub</span> content: VarChar&lt;<span class="hljs-number">40000</span>&gt;,<br>    <span class="hljs-keyword">pub</span> date: DateTime,<br>&#125;<br><br><span class="hljs-meta">#[record]</span><br><span class="hljs-meta">#[derive(Relate, FromParams)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Comment</span> &#123;<br>    <span class="hljs-keyword">pub</span> topic: ForeignKey&lt;Topic&gt;,<br>    <span class="hljs-keyword">pub</span> user: ForeignKey&lt;User&gt;,<br>    <span class="hljs-keyword">pub</span> content: VarChar&lt;<span class="hljs-number">40000</span>&gt;,<br>    <span class="hljs-keyword">pub</span> date: DateTime,<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>#[record]</code>会默认添加一个id字段，并且像<code>topic::date</code>这种字段就可以使用<code>order_by</code>来查询数据库。</li>
<li><code>Relate</code>表现的是实体之间的关系</li>
<li><code>FromParams</code> 将允许你从请求的参数中获取记录，也就是反序列化</li>
<li><code>ForeignKey</code> 用来表示外键约束，表示<code>Topic</code>和<code>User</code>有<code>多对一</code>的关系</li>
</ul>
<h2 id="5-迁移数据库"><a href="#5-迁移数据库" class="headerlink" title="5.迁移数据库"></a>5.迁移数据库</h2><p>在定义好记录结构后，即可生成迁移文件，同步到数据库，首先是第一步生成迁移文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ananc make-migrations forum/<br></code></pre></td></tr></table></figure>

<p>如果你想要查看本次迁移的SQL,那么就执行以下命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ananc sql-migrate forum 0001<br></code></pre></td></tr></table></figure>

<p>输出将会根据你所选的数据库所生成SQL,如果你使用的是postgresql,那么就会看到以下代码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> &quot;forum_topic&quot; (<br>	&quot;id&quot; <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">PRIMARY</span> KEY,<br>	&quot;title&quot; <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	&quot;user&quot; <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>		<span class="hljs-keyword">REFERENCES</span> &quot;auth_user&quot; (&quot;id&quot;)<br>		<span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE<br>		DEFERRABLE INITIALLY DEFERRED,<br>	&quot;content&quot; <span class="hljs-type">varchar</span>(<span class="hljs-number">40000</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	&quot;date&quot; <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>);<br><span class="hljs-keyword">CREATE</span> INDEX &quot;forum_topic_user_index&quot; <span class="hljs-keyword">ON</span> &quot;forum_topic&quot; (&quot;user&quot;);<br><br><span class="hljs-comment">--snip--</span><br><br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> &quot;forum_comment&quot; (<br>	&quot;id&quot; <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">PRIMARY</span> KEY,<br>	&quot;topic&quot; <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>		<span class="hljs-keyword">REFERENCES</span> &quot;forum_topic&quot; (&quot;id&quot;)<br>		<span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE<br>		DEFERRABLE INITIALLY DEFERRED,<br>	&quot;user&quot; <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>		<span class="hljs-keyword">REFERENCES</span> &quot;auth_user&quot; (&quot;id&quot;)<br>		<span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE<br>		DEFERRABLE INITIALLY DEFERRED,<br>	&quot;content&quot; <span class="hljs-type">varchar</span>(<span class="hljs-number">40000</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>	&quot;date&quot; <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span><br>);<br><span class="hljs-keyword">CREATE</span> INDEX &quot;forum_comment_topic_index&quot; <span class="hljs-keyword">ON</span> &quot;forum_comment&quot; (&quot;topic&quot;);<br><span class="hljs-keyword">CREATE</span> INDEX &quot;forum_comment_user_index&quot; <span class="hljs-keyword">ON</span> &quot;forum_comment&quot; (&quot;user&quot;);<br><br><span class="hljs-comment">--略--</span><br></code></pre></td></tr></table></figure>

<p>接下来应用迁移，执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ananc migrate<br></code></pre></td></tr></table></figure>

<h2 id="6-前端渲染记录"><a href="#6-前端渲染记录" class="headerlink" title="6.前端渲染记录"></a>6.前端渲染记录</h2><p>首先可以先生成前端文件，切到<code>forum</code>目录，然后运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ananc make-view topic<br></code></pre></td></tr></table></figure>

<p>就会生成<code>forum/topic/views.rs</code>文件，进行编辑</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> super::super::records::&#123;Topic, topic::date&#125;;<br><br><span class="hljs-meta">#[viewer]</span><br><span class="hljs-keyword">impl</span>&lt;R: Request&gt; TopicView&lt;R&gt; &#123;<br>    <span class="hljs-meta">#[view(Site::is_visitor)]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">index</span>(req: &amp;<span class="hljs-keyword">mut</span> R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">title</span> = <span class="hljs-string">&quot;Latest Topics&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">topics</span> = Topic::<span class="hljs-title function_ invoke__">order_by</span>(<span class="hljs-title function_ invoke__">date</span>().<span class="hljs-title function_ invoke__">desc</span>())<br>            .<span class="hljs-title function_ invoke__">limit</span>(<span class="hljs-number">25</span>).<span class="hljs-title function_ invoke__">query</span>(req).<span class="hljs-keyword">await</span>?;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>Site::is_visitor</code>将会校验是否是游客，如果是游客，也就是访问时，那么就会将”Latest Topics”赋值给变量title，然后再将最新的25个topic赋值给变量topics</p>
<p>接下来渲染这些变量到前端，打开<code>forum/topic/templates/index.rs.html</code>，进行如下改动</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html">@block title &#123;@title&#125;<br><br>@block content &#123;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>@title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>        @for topic in topics &#123;<br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>@topic.title<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        &#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到这种一种简单的模板语法，使用<code>@</code>来格式化变量成字符串，读者可以自行体会。</p>
<p>然后添加路由，打开<code>urls.rs</code>文件添加以下内容</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> crate::forum::&#123;<span class="hljs-keyword">self</span>, topic::views::TopicView&#125;;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">routes</span>&lt;R: Request&gt;() <span class="hljs-punctuation">-&gt;</span> Router&lt;R&gt; &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;&quot;</span>, TopicView::index)<br>        .<span class="hljs-title function_ invoke__">nest</span>(<span class="hljs-string">&quot;/topic&quot;</span>, forum::urls::<span class="hljs-title function_ invoke__">routes</span>()) <span class="hljs-comment">// 添加</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>此时你可以打开<code>http://127.0.0.1:9090/</code>，然而并不会看到任何topic,一个因为数据库本来就没有数据，一个是因为你需要加访问的路径，例如<code>http://127.0.0.1:9090/topic</code></p>
<h2 id="7-使用组件"><a href="#7-使用组件" class="headerlink" title="7. 使用组件"></a>7. 使用组件</h2><p>组件是用来做网页的交互的，其中真义只有跟着做下去才知道。</p>
<p>首先还是安装环境，进入项目根目录，也就是<code>mini-forum/</code>下，运行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ananc init-components<br></code></pre></td></tr></table></figure>

<p>This will create the mini-forum-comps and mini-forum-wasm crates. In mini-forum-comps&#x2F;Cargo.toml, add the following dependency:</p>
<p>这个操作将会创建<code>mini-forum-comps</code>和<code>mini-forum-wasm</code>包，在<code>mini-forum-comps/Cargo.toml</code>中添加以下依赖</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust">gloo-net = &#123; version = <span class="hljs-string">&quot;0.2&quot;</span>, features = [<span class="hljs-string">&quot;http&quot;</span>, <span class="hljs-string">&quot;json&quot;</span>] &#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>不建议随便更新版本，因为会出现无法预料的问题，rust就是这样的。</p>
</blockquote>
<p>然后创建<code>mini-forum-comps/src/loader.rs</code>，并写入以下内容</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi_aux::prelude::*;<br><span class="hljs-keyword">use</span> gloo_net::http::Request;<br><br><span class="hljs-meta">#[derive(Properties, Serialize, Deserialize)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LoaderProps</span> &#123;<br>    <span class="hljs-keyword">pub</span> load_url: <span class="hljs-type">String</span>,<br>    <span class="hljs-keyword">pub</span> show_url: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-meta">#[derive(Serialize, Deserialize)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Data</span> &#123;<br>    <span class="hljs-keyword">pub</span> id: <span class="hljs-type">String</span>,<br>    <span class="hljs-keyword">pub</span> title: <span class="hljs-type">String</span>,<br>&#125;<br><br><span class="hljs-meta">#[store]</span><br><span class="hljs-meta">#[derive(Serialize, Deserialize)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Loader</span> &#123;<br>    visible: <span class="hljs-type">bool</span>,<br>    page: <span class="hljs-type">u32</span>,<br>    fetched: <span class="hljs-type">Vec</span>&lt;Data&gt;,<br>&#125;<br><br><span class="hljs-meta">#[component(Loader)]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(props: LoaderProps) <span class="hljs-punctuation">-&gt;</span> Rsx &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">state</span> = <span class="hljs-keyword">Self</span>::<span class="hljs-title function_ invoke__">store</span>(<span class="hljs-literal">true</span>, <span class="hljs-number">1</span>, <span class="hljs-built_in">vec!</span>[]);<br><br>    <span class="hljs-keyword">let</span> (data_resource, handle_click) = resource!(<span class="hljs-type">Vec</span>&lt;Data&gt;, state, props, &#123;<br>        *state.<span class="hljs-title function_ invoke__">visible_mut</span>() = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">request</span> = Request::<span class="hljs-title function_ invoke__">get</span>(&amp;props.load_url)<br>            .<span class="hljs-title function_ invoke__">query</span>([(<span class="hljs-string">&quot;page&quot;</span>, state.<span class="hljs-title function_ invoke__">page</span>().<span class="hljs-title function_ invoke__">to_string</span>())]);<br>    &#125;);<br><br>    rsx!(state, props, data_resource, &#123;<br>        @<span class="hljs-keyword">for</span> <span class="hljs-variable">data</span> <span class="hljs-keyword">in</span> state.<span class="hljs-title function_ invoke__">fetched</span>() &#123;<br>            &lt;li&gt;@href props.show_url, data.id &#123;@data.title&#125;&lt;/li&gt;<br>        &#125;<br>	@resource data_resource, state &#123;<br>            Resource::Pending =&gt; &#123;<br>                &lt;div&gt;Loading...&lt;/div&gt;<br>            &#125;<br>            Resource::<span class="hljs-title function_ invoke__">Rejected</span>(_) =&gt; &#123;<br>                *state.<span class="hljs-title function_ invoke__">visible_mut</span>() = <span class="hljs-literal">true</span>;<br>                &lt;div&gt;Problem loading topics&lt;/div&gt;<br>            &#125;<br>            Resource::<span class="hljs-title function_ invoke__">Resolved</span>(<span class="hljs-keyword">mut</span> f) =&gt; &#123;<br>                <span class="hljs-keyword">if</span> f.<span class="hljs-title function_ invoke__">len</span>() == <span class="hljs-number">25</span> &amp;&amp; *state.<span class="hljs-title function_ invoke__">page</span>() &lt; <span class="hljs-number">3</span> &#123;<br>                    *state.<span class="hljs-title function_ invoke__">page_mut</span>() += <span class="hljs-number">1</span>;<br>                    *state.<span class="hljs-title function_ invoke__">visible_mut</span>() = <span class="hljs-literal">true</span>;<br>                &#125;<br>                state.<span class="hljs-title function_ invoke__">fetched_mut</span>().<span class="hljs-title function_ invoke__">append</span>(&amp;<span class="hljs-keyword">mut</span> f);<br>            &#125;<br>        &#125;<br>        @<span class="hljs-keyword">if</span> *state.<span class="hljs-title function_ invoke__">visible</span>() &#123;<br>            &lt;button @<span class="hljs-title function_ invoke__">onclick</span>(handle_click)&gt;Load more&lt;/button&gt;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>这段代码创建了一个按钮，点击后将请求到topics.</p>
</blockquote>
<p>现在修改<code>mini-forum-comps/src/lib.rs</code>，</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> loader;<br><br>anansi_aux::app_components! &#123;<br>    loader::Loader,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后在<code>src/main.rs</code>中就可以使用这个包了</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust">app_statics! &#123;<br>    admin,<br>    wasm_statics!(<span class="hljs-string">&quot;mini-forum-wasm&quot;</span>),<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后你就可以在<code>forum/topic/views.rs</code>中添加一个<code>load</code>方法</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::&#123;url, check, http_404&#125;;<br><span class="hljs-keyword">use</span> mini_forum_comps::loader::&#123;Loader, Data&#125;;<br><br><span class="hljs-meta">#[viewer]</span><br><span class="hljs-keyword">impl</span>&lt;R: Request&gt; TopicView&lt;R&gt; &#123;<br>    <span class="hljs-meta">#[view(Site::is_visitor)]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">index</span>(req: &amp;<span class="hljs-keyword">mut</span> R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">title</span> = <span class="hljs-string">&quot;Latest Topics&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">topics</span> = Topic::<span class="hljs-title function_ invoke__">order_by</span>(<span class="hljs-title function_ invoke__">date</span>().<span class="hljs-title function_ invoke__">desc</span>())<br>            .<span class="hljs-title function_ invoke__">limit</span>(<span class="hljs-number">25</span>).<span class="hljs-title function_ invoke__">query</span>(req).<span class="hljs-keyword">await</span>?;<br>        <span class="hljs-comment">// Replace with url!(req, Self::show) later.</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">show_url</span> = <span class="hljs-string">&quot;/topic&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">load_url</span> = url!(req, <span class="hljs-keyword">Self</span>::load);<br>    &#125;<br>    <span class="hljs-meta">#[check(Site::is_visitor)]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">load</span>(req: &amp;<span class="hljs-keyword">mut</span> R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">page</span>: <span class="hljs-type">u32</span> = req.<span class="hljs-title function_ invoke__">params</span>().<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;page&quot;</span>)?.<span class="hljs-title function_ invoke__">parse</span>()?;<br>        <span class="hljs-keyword">if</span> page &gt; <span class="hljs-number">3</span> &#123;<br>            http_404!();<br>        &#125;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">topics</span> = Topic::<span class="hljs-title function_ invoke__">order_by</span>(<span class="hljs-title function_ invoke__">date</span>().<span class="hljs-title function_ invoke__">desc</span>())<br>            .<span class="hljs-title function_ invoke__">limit</span>(<span class="hljs-number">25</span>).<span class="hljs-title function_ invoke__">offset</span>(<span class="hljs-number">25</span> * page).<span class="hljs-title function_ invoke__">query</span>(req).<span class="hljs-keyword">await</span>?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span>: <span class="hljs-type">Vec</span>&lt;Data&gt; = topics.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">map</span>(|t| &#123;<br>            Data &#123;id: t.<span class="hljs-title function_ invoke__">pk</span>().<span class="hljs-title function_ invoke__">to_string</span>(), title: t.title.<span class="hljs-title function_ invoke__">to_string</span>()&#125;<br>        &#125;).<span class="hljs-title function_ invoke__">collect</span>();<br>        <span class="hljs-title function_ invoke__">Ok</span>(Response::<span class="hljs-title function_ invoke__">from_json</span>(serde_json::<span class="hljs-title function_ invoke__">to_string</span>(&amp;data)?))<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后添加<code>load</code>的路由，文件位置<code>forum/urls.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> super::topic::views::TopicView;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">routes</span>&lt;R: Request&gt;() <span class="hljs-punctuation">-&gt;</span> Router&lt;R&gt; &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;load&quot;</span>, TopicView::load)<br>&#125;<br></code></pre></td></tr></table></figure>



<p>接下来就可以在前端进行调用了，文件位置<code>forum/topic/templates/index.rs.html</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust">@block content &#123;<br>    @load components &#123;<br>        &lt;h1&gt;@title&lt;/h1&gt;<br>        &lt;ul&gt;<br>            @<span class="hljs-keyword">for</span> <span class="hljs-variable">topic</span> <span class="hljs-keyword">in</span> &amp;topics &#123;<br>                &lt;li&gt;@topic.title&lt;/li&gt;<br>            &#125;<br>            @<span class="hljs-keyword">if</span> topics.<span class="hljs-title function_ invoke__">len</span>() == <span class="hljs-number">25</span> &#123;<br>                &lt;Loader @show_url @load_url /&gt;<br>            &#125;<br>        &lt;/ul&gt;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此时你再次运行web服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ananc run<br></code></pre></td></tr></table></figure>

<blockquote>
<p>当然，你也并不会看到什么东西，你进数据库添加几条内容就可以看到预期效果了</p>
</blockquote>
<h2 id="8-组件级css"><a href="#8-组件级css" class="headerlink" title="8. 组件级css"></a>8. 组件级css</h2><p>这部分内容搞前端的同学应该相当熟悉了，要实现的功能就是css只应用于当前的组件。</p>
<p>例如，创建一个spinner组件，文件<code>mini-forum-comps/src/spinner.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi_aux::prelude::*;<br><br><span class="hljs-meta">#[function_component(Spinner)]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>() <span class="hljs-punctuation">-&gt;</span> Rsx &#123;<br>    style! &#123;<br>        div &#123;<br>            display: inline-block;<br>            width: <span class="hljs-number">25</span>px;<br>            height: <span class="hljs-number">25</span>px;<br>            border: <span class="hljs-number">3</span>px solid #cfd0d1;<br>            border-radius: <span class="hljs-number">50</span>%;<br>            border-top-color: #<span class="hljs-number">1</span>c87c9;<br>            animation: spin <span class="hljs-number">1</span>s ease-<span class="hljs-keyword">in</span>-out infinite;<br>            -webkit-animation: spin <span class="hljs-number">1</span>s ease-<span class="hljs-keyword">in</span>-out infinite;<br>        &#125;<br>        @keyframes spin &#123;<br>            to &#123;<br>                -webkit-transform: <span class="hljs-title function_ invoke__">rotate</span>(<span class="hljs-number">360</span>deg);<br>            &#125;<br>        &#125;<br>        @-webkit-keyframes spin &#123;<br>            to &#123;<br>                -webkit-transform: <span class="hljs-title function_ invoke__">rotate</span>(<span class="hljs-number">360</span>deg);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    rsx! &#123;<br>        &lt;div&gt;&lt;/div&gt;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这段代码通过<code>function_component</code>创建了一个组件，因为他不需要状态管理，然后css写在了<code>style</code>宏内，现在将这些东西添加到<code>mini-forum-comps/src/lib.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> spinner;<br><br>anansi_aux::comp_statics! &#123;<br>    <span class="hljs-string">&quot;spinner&quot;</span>,<br>&#125;<br><br>anansi_aux::app_components! &#123;<br>    loader::Loader,<br>    spinner::Spinner,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注册这个组件，文件位置<code>src/main.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust">app_statics! &#123;<br>    admin,<br>    wasm_statics!(<span class="hljs-string">&quot;mini-forum-wasm&quot;</span>),<br>    eddit_comps,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这样你就可以在<code>loader</code>中使用了，文件位置<code>mini-forum-comps/src/loader.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> crate::spinner::Spinner;<br><br><span class="hljs-comment">// --省略--</span><br><br><span class="hljs-meta">#[component(Loader)]</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(props: LoaderProps) <span class="hljs-punctuation">-&gt;</span> Rsx &#123;<br>    <span class="hljs-comment">// --省略--</span><br><br>    rsx! &#123;<br>        @<span class="hljs-keyword">for</span> <span class="hljs-variable">data</span> <span class="hljs-keyword">in</span> &amp;state.fetched &#123;<br>            &lt;li&gt;@href props.show_url, data.id &#123;@data.title&#125;&lt;/li&gt;<br>        &#125;<br>	@resource data_resource &#123;<br>            Resource::Pending =&gt; &#123;<br>                &lt;Spinner /&gt;<br>            &#125;<br>            <span class="hljs-comment">// --省略--</span><br>        &#125;<br>        @<span class="hljs-keyword">if</span> state.visible &#123;<br>            &lt;button @<span class="hljs-title function_ invoke__">onclick</span>(handle_click)&gt;Load more&lt;/button&gt;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="9-集成-Tailwind"><a href="#9-集成-Tailwind" class="headerlink" title="9. 集成 Tailwind"></a>9. 集成 Tailwind</h2><p>首先安装Tailwind</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ananc init-tailwind<br></code></pre></td></tr></table></figure>

<p>然后在<code>forum/topic/templates/base.rs.html</code>中编辑</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust">&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>    &lt;head&gt;<br>        &lt;meta charset=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;<br>        &lt;title&gt;@block title&lt;/title&gt;<br>        &lt;link href=<span class="hljs-string">&quot;/static/styles/global.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span>&gt;<br>    &lt;/head&gt;<br>    &lt;body&gt;<br>        @block content<br>    &lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>这样你就可以在项目中使用Tailwind类了。</p>
<h2 id="10-添加缓存"><a href="#10-添加缓存" class="headerlink" title="10. 添加缓存"></a>10. 添加缓存</h2><p>首先添加序列化的依赖,文件位置<code>Cargo.toml</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">serde</span> = &#123; version = <span class="hljs-string">&quot;1.0&quot;</span>, features = [<span class="hljs-string">&quot;derive&quot;</span>] &#125;<br><span class="hljs-attr">serde_json</span> = <span class="hljs-string">&quot;1.0&quot;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>对于小型网站，默认使用Moka就可以了，如果是大型网站，那么建议你使用redis,按照以下步骤</p>
<ol>
<li>需要在<code>Cargo.toml</code>中添加<code>redis</code>特性，</li>
<li>在<code>src/project.rs</code>中将<code>app_cache!(local)</code> 换成 <code>app_cache!(redis)</code></li>
<li>在<code>settings.toml</code>中的<code>[caches.default]</code>字段添加<code>location = &quot;redis://127.0.0.1/&quot;</code></li>
</ol>
</blockquote>
<p>然后记录添加序列化相关特性，文件位置<code>forum/records.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;<br><br><span class="hljs-meta">#[record]</span><br><span class="hljs-meta">#[derive(Relate, FromParams, Serialize, Deserialize)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Topic</span> &#123;<br>    <span class="hljs-keyword">pub</span> title: VarChar&lt;<span class="hljs-number">200</span>&gt;,<br>    <span class="hljs-keyword">pub</span> user: ForeignKey&lt;User&gt;,<br>    <span class="hljs-keyword">pub</span> content: VarChar&lt;<span class="hljs-number">40000</span>&gt;,<br>    <span class="hljs-keyword">pub</span> date: DateTime,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后你就可以在视图层使用你的缓存了,文件位置<code>forum/topic/views.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::cache::prelude::*;<br><br><span class="hljs-meta">#[viewer]</span><br><span class="hljs-keyword">impl</span>&lt;R: Request&gt; TopicView&lt;R&gt; &#123;<br>    <span class="hljs-meta">#[view(Site::is_visitor)]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">index</span>(req: &amp;<span class="hljs-keyword">mut</span> R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">title</span> = <span class="hljs-string">&quot;Latest Topics&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">topics</span> = cache!(req, <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-number">30</span>), <span class="hljs-string">&quot;topic_index&quot;</span>, &#123;<br>            Topic::<span class="hljs-title function_ invoke__">order_by</span>(<span class="hljs-title function_ invoke__">date</span>().<span class="hljs-title function_ invoke__">desc</span>())<br>                .<span class="hljs-title function_ invoke__">limit</span>(<span class="hljs-number">25</span>).<span class="hljs-title function_ invoke__">query</span>(req).<span class="hljs-keyword">await</span>?<br>	&#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>缓存会每30s请求一次数据库到<code>topic_index</code></p>
</blockquote>
<h2 id="11-创建一个超级管理员"><a href="#11-创建一个超级管理员" class="headerlink" title="11. 创建一个超级管理员"></a>11. 创建一个超级管理员</h2><p>看到这里的伙伴应该一下就能想到django吧，这块简直就是rust版的django,你只需运行下面命令输入账号密码即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ananc admin<br></code></pre></td></tr></table></figure>

<p>创建好超级管理员账户以后， 运行web服务器，然后打开<code>http://127.0.0.1:9090/admin/login</code>就可以登陆了，自带了一个超级管理员后台</p>
<p><img src="https://i-blog.csdnimg.cn/direct/d0b4282459084acfa9549d2d98771fcf.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>管理后台主页</p>
<p><img src="https://i-blog.csdnimg.cn/direct/6dadd754b8d34b14b386fccef00f76ca.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"><br>然后你就可以添加用户了，点击<code>User</code> 右边的<code>Add</code></p>
<p><img src="https://i-blog.csdnimg.cn/direct/2965dd862b304607949c24b37b0e940d.png" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<h2 id="12-添加剩余视图"><a href="#12-添加剩余视图" class="headerlink" title="12. 添加剩余视图"></a>12. 添加剩余视图</h2><p>在<code> forum/records.rs</code>中添加</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::db::OrderBy;<br><span class="hljs-keyword">use</span> anansi::ToUrl;<br><br><span class="hljs-meta">#[record]</span><br><span class="hljs-meta">#[derive(Relate, FromParams, Serialize, Deserialize, ToUrl)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Topic</span> &#123;<br>    <span class="hljs-keyword">pub</span> title: VarChar&lt;<span class="hljs-number">200</span>&gt;,<br>    <span class="hljs-keyword">pub</span> user: ForeignKey&lt;User&gt;,<br>    <span class="hljs-keyword">pub</span> content: VarChar&lt;<span class="hljs-number">40000</span>&gt;,<br>    <span class="hljs-keyword">pub</span> date: DateTime,<br>&#125;<br><br><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Topic</span> &#123;<br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">recent_comments</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> OrderBy&lt;Comment&gt; &#123;<br>        Comment::<span class="hljs-title function_ invoke__">by_topic</span>(<span class="hljs-keyword">self</span>).<span class="hljs-title function_ invoke__">order_by</span>(comment::<span class="hljs-title function_ invoke__">date</span>().<span class="hljs-title function_ invoke__">desc</span>())<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>ToUrl</code>将会返回一个简写的<code>id</code>，例如<code>ixNr1-tGUe9</code>，<code>by_topic</code>是通过添加外键约束生成的，用来筛选结果。</p>
<p>然后添加路由，文件位置<code>forum/urls.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> super::topic::views::TopicView;<br><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">routes</span>&lt;R: Request&gt;() <span class="hljs-punctuation">-&gt;</span> Router&lt;R&gt; &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>    	<span class="hljs-comment">// 匹配例如 /topic/ixNr1-tGUe9</span><br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;&#123;topic_id&#125;&quot;</span>, TopicView::show)<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p><code>&#123;topic_id&#125;</code>将会匹配到请求url中的参数。</p>
</blockquote>
<p>然后更新<code>forum/topic/views.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::get_or_404;<br><span class="hljs-keyword">use</span> anansi::humanize::ago;<br><br><span class="hljs-meta">#[viewer]</span><br><span class="hljs-keyword">impl</span>&lt;R: Request&gt; TopicView&lt;R&gt; &#123;<br>    <span class="hljs-comment">// --省略--</span><br>    <span class="hljs-meta">#[view(Site::is_visitor)]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">show</span>(req: &amp;<span class="hljs-keyword">mut</span> R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">topic</span> = get_or_404!(Topic, req);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">title</span> = &amp;topic.title;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">poster</span> = topic.user.<span class="hljs-title function_ invoke__">get</span>(req).<span class="hljs-keyword">await</span>?.username;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">comments</span> = topic.<span class="hljs-title function_ invoke__">recent_comments</span>().<span class="hljs-title function_ invoke__">limit</span>(<span class="hljs-number">25</span>).<span class="hljs-title function_ invoke__">query</span>(req).<span class="hljs-keyword">await</span>?;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">users</span> = comments.<span class="hljs-title function_ invoke__">parents</span>(req, |c| &amp;c.user).<span class="hljs-keyword">await</span>?;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在<code>show</code>中，get_or_404! 宏将会通过<code>topic_id</code>来筛选指定的topic否则返回404错误，用户用<code>comments</code>来检索parents。</p>
<p>现在添加前端的模板<code>forum/topic/templates/show.rs.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs html">@block title &#123;@title&#125;<br><br>@block content &#123;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>@title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>Posted by @poster @ago(topic.date)<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>@topic.content<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    @for (comment, user) in comments.iter().zip(users.iter()) &#123;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>Posted by @user.username @ago(comment.date)<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>@comment.content<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后在Index中添加指向show的连接,文件位置<code>forum/topic/templates/index.rs</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html">@block content &#123;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>@title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>        @for topic in topics &#123;<br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>@link req, Self::show, topic &#123;@topic.title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        &#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>link</code>等同于</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;topic/@topic.to_url()&quot;</span>&gt;</span>@topic.title<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="13-实现用户登陆"><a href="#13-实现用户登陆" class="headerlink" title="13. 实现用户登陆"></a>13. 实现用户登陆</h2><p>本例子直接复用了管理员登陆的页面，当然，你也可以自己写一个页面，文件位置<code>forum/topic/views.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::handle;<br><span class="hljs-keyword">use</span> anansi::forms::ToRecord;<br><span class="hljs-keyword">use</span> anansi::util::auth::forms::UserLogin;<br><br><span class="hljs-meta">#[viewer]</span><br><span class="hljs-keyword">impl</span>&lt;R: Request&gt; TopicView&lt;R&gt; &#123;<br>    <span class="hljs-comment">// --省略--</span><br>    <span class="hljs-meta">#[view(Site::is_visitor)]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">login</span>(req: &amp;<span class="hljs-keyword">mut</span> R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">title</span> = <span class="hljs-string">&quot;Log in&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">button</span> = <span class="hljs-string">&quot;Log in&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">form</span> = handle!(UserLogin, ToRecord&lt;R&gt;, req, user, &#123;<br>            req.<span class="hljs-title function_ invoke__">auth</span>(&amp;user).<span class="hljs-keyword">await</span>?;<br>    	    req.<span class="hljs-title function_ invoke__">session</span>().<span class="hljs-title function_ invoke__">set_and_redirect</span>(req, <span class="hljs-keyword">Self</span>::index)<br>        &#125;)?;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>handle!</code>宏会创建一个新的form,如果请求是<code>GET</code>的话。否则将提交表单登陆，如果失败则返回结果，你可以在<code>forum/topic/templates/login.rs.html</code>中找到他</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs html">@block title &#123;@title&#125;<br><br>@block content &#123;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>@title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    	@build form &#123;<br>	    @unescape form.errors()<br>    	    @for field in form.fields() &#123;<br>    	        @unescape field.label_tag()<br>    	        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>		    @unescape field<br>		    @unescape field.errors()<br>    	        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    	    &#125;<br>	    @unescape form.submit(button)<br>    	&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用模板来构建表单要比纯html实现安全的多。错误就使用无序列表显示了</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-errors&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Problem with username or password.<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>字段中的错误将会被<code>field-errors</code>所代替</p>
<p>然后添加路由,文件位置<code>urls.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">routes</span>&lt;R: Request&gt;() <span class="hljs-punctuation">-&gt;</span> Router&lt;R&gt; &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/&quot;</span>, TopicView::index)<br>        .<span class="hljs-title function_ invoke__">nest</span>(<span class="hljs-string">&quot;/topic&quot;</span>, forum::urls::<span class="hljs-title function_ invoke__">routes</span>())<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;/login&quot;</span>, TopicView::login)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>现在就可以用超管页面登陆用户账号了。</p>
<h2 id="14-实现创建帖子"><a href="#14-实现创建帖子" class="headerlink" title="14. 实现创建帖子"></a>14. 实现创建帖子</h2><p>在<code>forum/forms.rs</code>中添加一个表单</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> crate::prelude::*;<br><span class="hljs-keyword">use</span> anansi::records::&#123;DateTime, ForeignKey&#125;;<br><span class="hljs-keyword">use</span> anansi::forms::&#123;VarChar, ToRecord&#125;;<br><span class="hljs-keyword">use</span> super::records::Topic;<br><br><span class="hljs-meta">#[form(Topic)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TopicForm</span> &#123;<br>    <span class="hljs-keyword">pub</span> title: VarChar&lt;<span class="hljs-number">200</span>&gt;,<br>    <span class="hljs-keyword">pub</span> content: VarChar&lt;<span class="hljs-number">40000</span>&gt;,<br>&#125;<br><br><span class="hljs-meta">#[async_trait]</span><br><span class="hljs-keyword">impl</span>&lt;R: Request&gt; ToRecord&lt;R&gt; <span class="hljs-keyword">for</span> <span class="hljs-title class_">TopicForm</span> &#123;<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_post</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, data: TopicFormData, req: &amp;R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Topic&gt; &#123;<br>        Topic::<span class="hljs-title function_ invoke__">new</span>()<br>            .<span class="hljs-title function_ invoke__">title</span>(data.title)<br>            .<span class="hljs-title function_ invoke__">user</span>(ForeignKey::<span class="hljs-title function_ invoke__">from_data</span>(req.<span class="hljs-title function_ invoke__">user</span>().<span class="hljs-title function_ invoke__">pk</span>())?)<br>            .<span class="hljs-title function_ invoke__">content</span>(data.content)<br>            .<span class="hljs-title function_ invoke__">date</span>(DateTime::<span class="hljs-title function_ invoke__">now</span>())<br>            .<span class="hljs-title function_ invoke__">saved</span>(req)<br>            .<span class="hljs-keyword">await</span><br>            .<span class="hljs-title function_ invoke__">or</span>(form_error!(<span class="hljs-string">&quot;Problem adding topic&quot;</span>))<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>#[form(Topic)]</code>生成了一个<code>TopicFormData</code>结构，将会保持表单中的数据，并且与<code>Topic</code>关联. <code>on_post</code>将会尝试将表单数据转化成一个记录。<code>form_error</code>将会简单的创建一个<code>FormError</code>，它将会与表单的<code>errors</code>关联。</p>
<p>然后在<code>forum/mod.rs</code>添加</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> forms;<br></code></pre></td></tr></table></figure>

<p>然后在<code>forum/topic/views.rs</code>中使用他</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::&#123;check, extend&#125;;<br><span class="hljs-keyword">use</span> crate::forum::forms::TopicForm;<br><br><span class="hljs-meta">#[viewer]</span><br><span class="hljs-keyword">impl</span>&lt;R: Request&gt; TopicView&lt;R&gt; &#123;<br>    <span class="hljs-comment">// --snip--</span><br>    <span class="hljs-meta">#[check(Site::is_auth)]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(req: &amp;<span class="hljs-keyword">mut</span> R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">title</span> = <span class="hljs-string">&quot;New Topic&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">button</span> = <span class="hljs-string">&quot;Create&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">form</span> = handle!(TopicForm, ToRecord&lt;R&gt;, req, |topic| &#123;<br>    	    <span class="hljs-title function_ invoke__">Ok</span>(redirect!(req, <span class="hljs-keyword">Self</span>::show, topic))<br>        &#125;)?;<br>        extend!(req, base, <span class="hljs-string">&quot;login&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>Site::is_auth</code>实现了如果用户未登陆则重定向到访客页面。由于重定向不是异步的，所以给<code>handle!</code>宏传递一个闭包。至于模板，你可以简单的复用<code>login.rs.html</code>通过使用<code>check</code>和<code>extend</code>宏，如果是实际要用的网站，你就需要自定义了。如果用户已经登陆了，也可以添加一个连接到<code>index.rs.html</code>的链接。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs html">@block content &#123;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>@title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    @if req.user().is_auth() &#123;<br>	@link req, Self::new &#123;New Topic&#125;<br>    &#125;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>        @for topic in topics &#123;<br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>@link req, Self::show, topic &#123;@topic.title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        &#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后添加路由, 文件位置<code>urls.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">routes</span>&lt;R: Request&gt;() <span class="hljs-punctuation">-&gt;</span> Router&lt;R&gt; &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;new&quot;</span>, TopicView::new)<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;&#123;topic_id&#125;&quot;</span>, TopicView::show)<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="15-实现更新帖子功能"><a href="#15-实现更新帖子功能" class="headerlink" title="15. 实现更新帖子功能"></a>15. 实现更新帖子功能</h2><p>首先需要给记录添加特性，文件位置<code>forum/forms.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::&#123;GetData, ToEdit&#125;;<br><br><span class="hljs-meta">#[form(Topic)]</span><br><span class="hljs-meta">#[derive(GetData, ToEdit)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TopicForm</span> &#123;<br>    <span class="hljs-keyword">pub</span> title: VarChar&lt;<span class="hljs-number">200</span>&gt;,<br>    <span class="hljs-keyword">pub</span> content: VarChar&lt;<span class="hljs-number">40000</span>&gt;,<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后添加一个视图</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::handle_or_404;<br><span class="hljs-keyword">use</span> anansi::forms::ToEdit;<br><br><span class="hljs-meta">#[viewer]</span><br><span class="hljs-keyword">impl</span>&lt;R: Request&gt; TopicView&lt;R&gt; &#123;<br>    <span class="hljs-comment">// --snip--</span><br>    <span class="hljs-meta">#[check(Topic::owner)]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">edit</span>(req: &amp;<span class="hljs-keyword">mut</span> R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">title</span> = <span class="hljs-string">&quot;Update Topic&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">button</span> = <span class="hljs-string">&quot;Update&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">form</span> = handle_or_404!(TopicForm, ToEdit&lt;R&gt;, req, |topic| &#123;<br>    	    <span class="hljs-title function_ invoke__">Ok</span>(redirect!(req, <span class="hljs-keyword">Self</span>::show, topic))<br>        &#125;)?;<br>        extend!(req, base, <span class="hljs-string">&quot;login&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>Topic::owner</code>将会检查文章是否是自己的。<code>handle_or_404!</code>宏与<code>handle!</code>类似，但是如果记录找不到则返回404.其余的跟之前一样，继续复用<code>login.rs.html</code>，如果文章是自己的，那么你也可以在<code>show.rs.html</code>添加一个链接，如果这篇文章的作者就是当前用户。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html">@block content &#123;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>@title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>Posted by @poster @ago(topic.date)<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>@topic.content<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    @if topic.user.pk() == req.user().pk() &#123;<br>        @link req, Self::edit, topic &#123;Edit&#125;<br>    &#125;<br>    @for (comment, user) in comments.iter().zip(users.iter()) &#123;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>Posted by @user.username @ago(comment.created)<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>@comment.content<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接着更新路由</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">routes</span>&lt;R: Request&gt;() <span class="hljs-punctuation">-&gt;</span> Router&lt;R&gt; &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;new&quot;</span>, TopicView::new)<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;&#123;topic_id&#125;&quot;</span>, TopicView::show)<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;&#123;topic_id&#125;/edit&quot;</span>, TopicView::edit)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="16-超级管理员的功能"><a href="#16-超级管理员的功能" class="headerlink" title="16. 超级管理员的功能"></a>16. 超级管理员的功能</h2><p>将<code>Topic</code>添加到超管后台</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> anansi::&#123;init_admin, register, record_admin&#125;;<br><span class="hljs-keyword">use</span> super::records::Topic;<br><br>init_admin! &#123;<br>    register!(Topic),<br>&#125;<br><br>record_admin! &#123;Topic,<br>    <span class="hljs-comment">// You can specify which fields (if any) should be searchable</span><br>    search_fields: [title, content, date],<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后在<code>forum/mod.rs</code>中添加</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">mod</span> admin;<br></code></pre></td></tr></table></figure>

<p>然后在<code>main.rs</code>中添加</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust">app_admins! &#123;<br>    auth,<br>    forum,<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://i-blog.csdnimg.cn/direct/45516e1b6daa403ea0dfd87beaef8a9a.png#pic_center" srcset="/img/loading.gif" lazyload alt="在这里插入图片描述"></p>
<p><code>Topic</code>将会在<code>/admin/forum/topic</code>中显示。</p>
<h2 id="17-实现删除帖子功能"><a href="#17-实现删除帖子功能" class="headerlink" title="17. 实现删除帖子功能"></a>17. 实现删除帖子功能</h2><p>首先视图添加一个方法,文件位置<code>forum/topic/views.rs</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[viewer]</span><br><span class="hljs-keyword">impl</span>&lt;R: Request&gt; TopicView&lt;R&gt; &#123;<br>    <span class="hljs-comment">// --省略--</span><br>    <span class="hljs-meta">#[view(Topic::owner)]</span><br>    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">destroy</span>(req: &amp;<span class="hljs-keyword">mut</span> R) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Response&gt; &#123;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">title</span> = <span class="hljs-string">&quot;Delete topic&quot;</span>;<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">topic</span> = get_or_404!(Topic, req);<br>        <span class="hljs-keyword">let</span> <span class="hljs-variable">form</span> = handle!(req, R, &#123;<br>            topic.<span class="hljs-title function_ invoke__">delete</span>(req).<span class="hljs-keyword">await</span>?;<br>            <span class="hljs-title function_ invoke__">Ok</span>(redirect!(req, <span class="hljs-keyword">Self</span>::index))<br>        &#125;)?;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>forum/topic/templates/destroy.rs.html</code>中代码非常简单</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html">@block title &#123;@title&#125;<br><br>@block content &#123;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>@title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    Are you sure you want to delete the topic &quot;@topic.title&quot;?<br>    @build form &#123;<br>        @unescape form.submit(&quot;Confirm&quot;)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后在<code>forum/topic/templates/show.rs.html</code>中添加一个链接</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs html">@block content &#123;<br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>@title<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>Posted by @poster @ago(topic.date)<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>@topic.content<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    @if topic.user.pk() == req.user().pk() &#123;<br>        @link req, Self::edit, topic &#123;Edit&#125;<br>        @link req, Self::destroy, topic &#123;Delete&#125;<br>    &#125;<br>    @for (comment, user) in comments.iter().zip(users.iter()) &#123;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">small</span>&gt;</span>Posted by @user.username @ago(comment.created)<span class="hljs-tag">&lt;/<span class="hljs-name">small</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>@comment.content<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后再添加路由</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">routes</span>&lt;R: Request&gt;() <span class="hljs-punctuation">-&gt;</span> Router&lt;R&gt; &#123;<br>    Router::<span class="hljs-title function_ invoke__">new</span>()<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;new&quot;</span>, TopicView::new)<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;&#123;topic_id&#125;&quot;</span>, TopicView::new)<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;&#123;topic_id&#125;/edit&quot;</span>, TopicView::edit)<br>        .<span class="hljs-title function_ invoke__">route</span>(<span class="hljs-string">&quot;&#123;topic_id&#125;/destroy&quot;</span>, TopicView::destroy)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>到现在为止，本项目就算完成了，虽然功能不多，但耗时也挺久的，这些内容已经足够你开始做出自己的网站了，再深入的东西就没有，不然为什么叫轻量级web框架呢，后续的内容就需要自己探索了，但是光从这篇帖子就可以知道这个web框架做一些简单的应用还是很方便的，但是由于这个框架使用的是rust,学习难度高，但是框架不是很完善，所以性价比就比较差了，暂且可以当个玩具耍耍。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a>
                    
                      <a class="hover-with-bg" href="/categories/rust/">rust</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E5%90%8E%E7%AB%AF/">后端</a>
                    
                      <a class="hover-with-bg" href="/tags/%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/">核心技术</a>
                    
                      <a class="hover-with-bg" href="/tags/rust/">rust</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/13/%E3%80%90NodeJs%E3%80%91%E8%BD%BB%E6%9D%BE%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%BA%AFts%E9%A1%B9%E7%9B%AE-tsground/">
                        <span class="hidden-mobile">【NodeJs】轻松构建一个纯ts项目-tsground</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="twikoo"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/twikoo/1.6.8/twikoo.all.min.js', function() {
        var options = Object.assign(
          {"envId":"https://twikoo-comment-amber.vercel.app/","region":"ap-shanghai","path":"window.location.pathname"},
          {
            el: '#twikoo',
            path: 'window.location.pathname',
            onCommentLoaded: function() {
              Fluid.plugins.initFancyBox('#twikoo .tk-content img:not(.tk-owo-emotion)');
            }
          }
        )
        twikoo.init(options)
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        晋ICP备19013417号-1
      </a>
    </span>
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/cardlink@1.0.2/dist/cardlink.js" ></script>
  
    <script  src="https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js" ></script>
  
  
    <script  src="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js" ></script>
  
  
    <script defer src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?fb662cce851f414746e9757acbf65392";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', '[object Object]', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  




  
<script src="/js/enable_cardjs.js"></script>



<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


<!-- hexo injector body_end start --><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1485372591247153"crossorigin="anonymous"></script><ins class="adsbygoogle"style="display:block; text-align:center;"data-ad-layout="in-article"data-ad-format="fluid"data-ad-client="ca-pub-1485372591247153"data-ad-slot="3022038793"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1485372591247153"crossorigin="anonymous"></script><!--展示广告--><ins class="adsbygoogle"style="display:block"data-ad-client="ca-pub-1485372591247153"data-ad-slot="6470329219"data-ad-format="auto"data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1485372591247153"crossorigin="anonymous"></script><ins class="adsbygoogle"style="display:block"data-ad-format="fluid"data-ad-layout-key="-eo-83+c6+9n-qx"data-ad-client="ca-pub-1485372591247153"data-ad-slot="1656986235"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({});</script><!-- hexo injector body_end end --></body>
</html>
